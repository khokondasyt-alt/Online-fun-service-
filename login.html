<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login - Online Fun Service</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
body {
  font-family: 'Poppins', sans-serif;
  background: linear-gradient(180deg, #fddb92, #fff176);
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  margin: 0;
}
.container {
  background: rgba(255,255,255,0.2);
  padding: 30px;
  border-radius: 15px;
  width: 330px;
  text-align: center;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}
h2 {
  margin-bottom: 20px;
  color: #00008B;
}
input {
  width: 100%;
  padding: 10px;
  margin: 8px 0;
  border: none;
  border-radius: 8px;
}
button {
  width: 100%;
  padding: 10px;
  margin-top: 12px;
  border: none;
  border-radius: 8px;
  background: #00008B;
  color: white;
  font-weight: 600;
  cursor: pointer;
}
button:hover { opacity: 0.9; }
a { display: block; margin-top: 15px; color: #00008B; text-decoration: underline; }
.error { color: red; font-size: 13px; margin-top: 5px; }
</style>
</head>
<body>
<div class="container">
  <h2>Login</h2>
  <input type="text" id="mobile" placeholder="Mobile Number" maxlength="10">
  <div id="mobileError" class="error"></div>

  <input type="password" id="password" placeholder="Password">
  <div id="passwordError" class="error"></div>

  <button onclick="login()">Login</button>
  <a href="register.html">Create New Account</a>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCKeFUWUchjQtDo9gxrSSJvMaK9lUAigBk",
  authDomain: "puja-fun.firebaseapp.com",
  databaseURL: "https://puja-fun-default-rtdb.firebaseio.com",
  projectId: "puja-fun",
  storageBucket: "puja-fun.appspot.com",
  messagingSenderId: "85559207543",
  appId: "1:85559207543:web:0a280345399932b3da4872"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===== LOGIN FUNCTION =====
function login(){
  document.getElementById("mobileError").innerText="";
  document.getElementById("passwordError").innerText="";

  const mobile = document.getElementById("mobile").value.trim();
  const password = document.getElementById("password").value.trim();
  let valid = true;

  if(!/^\d{10}$/.test(mobile)){
    document.getElementById("mobileError").innerText="Enter valid 10-digit mobile";
    valid = false;
  }
  if(!password){
    document.getElementById("passwordError").innerText="Enter password";
    valid = false;
  }
  if(!valid) return;

  // Check user from Firebase
  db.ref("users").orderByChild("mobile").equalTo(mobile).once("value", snapshot=>{
    if(snapshot.exists()){
      const users = snapshot.val();
      const uid = Object.keys(users)[0];
      const user = users[uid];

      if(user.password === password){
        // Save local login info
        localStorage.setItem("loggedUser", JSON.stringify({ ...user, uid }));

        // Save login info to Firebase
        const logRef = db.ref("loggedUsers/" + uid);
        const now = new Date();
        const time = now.toLocaleString("en-IN", { timeZone: "Asia/Kolkata" });

        logRef.set({
          uid: uid,
          name: user.fullname,
          mobile: user.mobile,
          role: user.role,
          loginTime: time,
          status: "online"
        });

        // ✅ Login success হলে APK ডাউনলোড
        alert("✅ Login Successful! Downloading Online Fun Service App...");
        const link = document.createElement('a');
        link.href = 'https://github.com/khokondasyt-alt/Online-fun-service-/raw/main/onlinefunservice.apk';
        link.download = 'OnlineFunService.apk';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

      } else {
        alert("❌ Incorrect password!");
      }

    } else {
      alert("❌ Mobile number not registered!");
    }
  });
}

// ===== LOGOUT FUNCTION =====
function logout(){
  const user = JSON.parse(localStorage.getItem("loggedUser"));
  if(user && user.uid){
    db.ref("loggedUsers/" + user.uid).update({
      status: "offline",
      logoutTime: new Date().toLocaleString("en-IN", {timeZone:"Asia/Kolkata"})
    });
  }
  localStorage.removeItem("loggedUser");
  window.location.href="login.html";
}
</script>
</body>
</html>